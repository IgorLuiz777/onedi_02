import OpenAI from 'openai';
import { adicionarVocabulario, buscarPalavrasRevisao, registrarSessaoEstudo, salvarProgressoLicao } from './database.js';
import { obterProximaAula, obterAulaPorId, calcularProgressoNivel } from './lessonProgression.js';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const promptsModos = {
  aula_guiada: {
    system: (professor, idioma, nome, nivel, aulaAtual, historicoAulas, etapaAula) => `
      Voc√™ √© ${professor}, um professor especializado em ${idioma} conduzindo uma AULA GUIADA CONT√çNUA INTERATIVA.

      INFORMA√á√ïES DO ALUNO:
      - Nome: ${nome}
      - N√≠vel atual: ${nivel}
      - Aula atual: ${aulaAtual.topico}
      - Conte√∫do da aula: ${aulaAtual.conteudo}
      - Etapa da aula: ${etapaAula}

      HIST√ìRICO DE AULAS ANTERIORES:
      ${historicoAulas}

      METODOLOGIA DE AULA GUIADA INTERATIVA:

      ${{'intermediario': true, 'avan√ßado': true, 'avancado': true}[nivel?.toLowerCase()] ? `IMPORTANTE: A partir do n√≠vel intermedi√°rio, conduza a aula majoritariamente em ingl√™s. Use portugu√™s apenas para explica√ß√µes essenciais ou quando o aluno demonstrar dificuldade. Todas as instru√ß√µes, perguntas e feedbacks devem ser preferencialmente em ingl√™s.` : ''}

      üéØ ESTRUTURA DA AULA (siga esta sequ√™ncia):
      1. EXPLICA√á√ÉO_INICIAL - Explique o t√≥pico em ${idioma} e portugu√™s
      2. EXEMPLOS_PRATICOS - D√™ exemplos claros e contextualizados
      3. EXERCICIO_MULTIPLA_ESCOLHA - Crie quest√µes de m√∫ltipla escolha
      4. SOLICITAR_IMAGEM - Pe√ßa para gerar uma imagem relacionada ao t√≥pico
      5. DESCRICAO_IMAGEM - Aluno descreve a imagem gerada
      6. EXERCICIO_AUDIO - Solicite que o aluno grave √°udio
      7. CORRECAO_PRONUNCIA - Analise e corrija a pron√∫ncia
      8. FORMACAO_FRASES - Pe√ßa para formar frases
      9. CORRECAO_GRAMATICAL - Corrija erros gramaticais
      10. REVISAO_VOCABULARIO - Revise palavras aprendidas
      11. AVALIACAO_PROGRESSO - Avalie o progresso na aula

      üìö INSTRU√á√ïES ESPEC√çFICAS POR ETAPA:

      IMPORTANTE: Em cada etapa, DEIXE CLARO para o aluno qual a√ß√£o ele deve realizar, usando frases diretas como "Agora envie um √°udio", "Responda o question√°rio abaixo", "Descreva a imagem", etc. Nunca deixe d√∫vidas sobre o que o aluno deve fazer em seguida.

      EXPLICA√á√ÉO_INICIAL:
      - Explique primeiro em ${idioma}, depois em portugu√™s
      - Use linguagem clara e did√°tica
      - Conecte com conhecimentos anteriores

      EXERCICIO_MULTIPLA_ESCOLHA:
      - Crie 3-4 op√ß√µes com emojis: üÖ∞Ô∏è üÖ±Ô∏è üÖ≤Ô∏è üÖ≥Ô∏è
      - Quest√µes progressivas em dificuldade
      - Feedback imediato com explica√ß√£o

      SOLICITAR_IMAGEM:
      - Descreva que tipo de imagem ser√° gerada
      - Explique como ela se relaciona com o t√≥pico
      - Use o comando: [GERAR_IMAGEM: descri√ß√£o detalhada]

      EXERCICIO_AUDIO:
      - Pe√ßa para o aluno gravar palavras/frases espec√≠ficas
      - Use o comando: [SOLICITAR_AUDIO: texto_para_pronunciar]
      - D√™ instru√ß√µes claras de pron√∫ncia

      FORMACAO_FRASES:
      - Pe√ßa frases usando vocabul√°rio espec√≠fico
      - Varie os tipos: afirmativas, negativas, interrogativas
      - Corrija imediatamente com explica√ß√£o

      ‚úÖ CORRE√á√ÉO OBRIGAT√ìRIA:
      - TODA resposta deve ser corrigida se houver erro
      - Explique o erro em portugu√™s e a forma correta em ${idioma}
      - Reforce com exemplos adicionais
      - Seja encorajador mesmo ao corrigir

      üéØ INTERA√á√ÉO ATIVA:
      - Mantenha o aluno sempre engajado
      - Varie os tipos de exerc√≠cios
      - Use gamifica√ß√£o com pontua√ß√£o
      - Celebre acertos com entusiasmo

      üß† ADAPTA√á√ÉO INTELIGENTE:
      - Se o aluno erra muito, simplifique
      - Se acerta tudo, aumente a dificuldade
      - Repita conceitos quando necess√°rio
      - Conecte com aulas anteriores

      IMPORTANTE: Voc√™ deve conduzir a aula passo a passo, seguindo a estrutura definida. Nunca pule etapas. Sempre indique qual etapa est√° executando.
    `,
    user: (mensagem, aulaAtual, etapaAula) => `
      CONTEXTO DA AULA: ${aulaAtual.topico} - ${aulaAtual.conteudo}
      ETAPA ATUAL: ${etapaAula}

      Resposta do aluno: "${mensagem}"

      Continue a aula seguindo a metodologia estruturada. Conduza a pr√≥xima etapa apropriada.
    `
  },

  pratica_livre: {
    system: (professor, idioma, nome, nivel) => `
      Voc√™ √© ${professor}, conversando naturalmente com ${nome} em ${idioma}.
      N√≠vel do aluno: ${nivel}.

      INSTRU√á√ïES:
      - Mantenha uma conversa natural em ${idioma}
      - Use temas atuais e cotidianos
      - Corrija erros sutilmente, reformulando a frase correta
      - Adapte seu vocabul√°rio ao n√≠vel do aluno
      - Seja amig√°vel e encorajador
      - Fa√ßa perguntas para manter a conversa fluindo
    `,
    user: (mensagem) => `Continue esta conversa natural: "${mensagem}"`
  },

  modo_professor: {
    system: (professor, idioma, nome, nivel) => `
      Voc√™ √© ${professor}, um especialista em ${idioma} dando explica√ß√µes detalhadas para ${nome}.
      N√≠vel: ${nivel}.

      INSTRU√á√ïES:
      - Responda em ${idioma} com explica√ß√µes claras
      - Forne√ßa exemplos pr√°ticos
      - Explique regras gramaticais quando relevante
      - Use analogias para facilitar o entendimento
      - Seja paciente e detalhado nas explica√ß√µes
      - Ofere√ßa exerc√≠cios pr√°ticos quando apropriado
    `,
    user: (mensagem) => `Explique detalhadamente sobre: "${mensagem}"`
  },

  modo_vocabulario: {
    system: (professor, idioma, nome, nivel) => `
      Voc√™ √© ${professor} ensinando vocabul√°rio em ${idioma} para ${nome}.
      N√≠vel: ${nivel}.

      INSTRU√á√ïES:
      - Apresente 3-5 palavras novas por sess√£o
      - D√™ exemplos de uso em frases
      - Crie associa√ß√µes e dicas de memoriza√ß√£o
      - Fa√ßa exerc√≠cios de repeti√ß√£o espa√ßada
      - Use t√©cnicas de gamifica√ß√£o
      - Responda sempre em ${idioma}
    `,
    user: (mensagem) => `Ensine vocabul√°rio relacionado a: "${mensagem}"`
  }
};

export async function processarModoEstudo(estado, mensagem, usuarioBanco) {
  const { modo, idioma, professor, nome } = estado;
  const nivel = usuarioBanco?.nivel || 'iniciante';

  if (modo === 'aula_guiada') {
    return await processarAulaGuiada(estado, mensagem, usuarioBanco);
  }

  const promptConfig = promptsModos[modo];
  if (!promptConfig) {
    throw new Error(`Modo de estudo inv√°lido: ${modo}`);
  }

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        {
          role: 'system',
          content: promptConfig.system(professor, idioma, nome, nivel)
        },
        {
          role: 'user',
          content: promptConfig.user(mensagem)
        }
      ],
      temperature: 0.7,
      max_tokens: 400
    });

    const resposta = completion.choices[0].message.content;

    if (modo === 'modo_vocabulario') {
      await extrairEAdicionarVocabulario(resposta, usuarioBanco.id, idioma);
    }

    return {
      resposta,
      incluirTraducao: true,
      incluirAudio: true
    };

  } catch (error) {
    console.error('Erro ao processar modo de estudo:', error);
    throw error;
  }
}

async function processarAulaGuiada(estado, mensagem, usuarioBanco) {
  const { idioma, professor, nome } = estado;
  const nivel = usuarioBanco?.nivel || 'iniciante';

  // Obt√©m a aula atual do usu√°rio
  const aulaAtualId = usuarioBanco?.aula_atual || 1;
  const aulaAtual = obterAulaPorId(idioma, aulaAtualId) || obterProximaAula(idioma, 0);

  // Determina a etapa da aula baseada no progresso
  const etapaAula = determinarEtapaAula(mensagem, estado.etapaAulaAtual || 'EXPLICACAO_INICIAL');

  // Gera hist√≥rico das √∫ltimas 3 aulas para contexto
  const historicoAulas = gerarHistoricoAulas(idioma, aulaAtualId);

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        {
          role: 'system',
          content: promptsModos.aula_guiada.system(professor, idioma, nome, nivel, aulaAtual, historicoAulas, etapaAula)
        },
        {
          role: 'user',
          content: promptsModos.aula_guiada.user(mensagem, aulaAtual, etapaAula)
        }
      ],
      temperature: 0.7,
      max_tokens: 600
    });

    let resposta = completion.choices[0].message.content;

    // Processa comandos especiais na resposta
    const resultado = await processarComandosEspeciais(resposta, idioma, aulaAtual);

    // Atualiza a etapa da aula no estado
    estado.etapaAulaAtual = proximaEtapaAula(etapaAula);

    // Salva progresso da aula
    await salvarProgressoLicao(usuarioBanco.id, `aula_${aulaAtual.id}`, 'aula_guiada', {
      questoesRespondidas: 1,
      questoesCorretas: 1,
      tempoGasto: 3,
      completada: false
    });

    // Extrai vocabul√°rio da resposta
    await extrairEAdicionarVocabulario(resposta, usuarioBanco.id, idioma);

    return {
      resposta: resultado.resposta,
      aulaAtual: aulaAtual,
      imagemGerada: resultado.imagemGerada,
      audioSolicitado: resultado.audioSolicitado,
      incluirTraducao: true,
      incluirAudio: true
    };

  } catch (error) {
    console.error('Erro ao processar aula guiada:', error);
    throw error;
  }
}

function determinarEtapaAula(mensagem, etapaAtual) {
  const etapas = [
    'EXPLICACAO_INICIAL',
    'EXEMPLOS_PRATICOS',
    'EXERCICIO_MULTIPLA_ESCOLHA',
    'SOLICITAR_IMAGEM',
    'DESCRICAO_IMAGEM',
    'EXERCICIO_AUDIO',
    'CORRECAO_PRONUNCIA',
    'FORMACAO_FRASES',
    'CORRECAO_GRAMATICAL',
    'REVISAO_VOCABULARIO',
    'AVALIACAO_PROGRESSO'
  ];

  // Se √© a primeira mensagem da aula, come√ßa pela explica√ß√£o
  if (!mensagem || mensagem.toLowerCase().includes('come√ßar') || mensagem.toLowerCase().includes('iniciar')) {
    return 'EXPLICACAO_INICIAL';
  }

  // Avan√ßa para a pr√≥xima etapa baseada na atual
  const indiceAtual = etapas.indexOf(etapaAtual);
  if (indiceAtual >= 0 && indiceAtual < etapas.length - 1) {
    return etapas[indiceAtual + 1];
  }

  return etapaAtual;
}

function proximaEtapaAula(etapaAtual) {
  const etapas = [
    'EXPLICACAO_INICIAL',
    'EXEMPLOS_PRATICOS',
    'EXERCICIO_MULTIPLA_ESCOLHA',
    'SOLICITAR_IMAGEM',
    'DESCRICAO_IMAGEM',
    'EXERCICIO_AUDIO',
    'CORRECAO_PRONUNCIA',
    'FORMACAO_FRASES',
    'CORRECAO_GRAMATICAL',
    'REVISAO_VOCABULARIO',
    'AVALIACAO_PROGRESSO'
  ];

  const indiceAtual = etapas.indexOf(etapaAtual);
  if (indiceAtual >= 0 && indiceAtual < etapas.length - 1) {
    return etapas[indiceAtual + 1];
  }

  return 'AVALIACAO_PROGRESSO'; // √öltima etapa
}

async function processarComandosEspeciais(resposta, idioma, aulaAtual) {
  let respostaProcessada = resposta;
  let imagemGerada = null;
  let audioSolicitado = null;

  // Processa comando de gera√ß√£o de imagem
  const regexImagem = /\[GERAR_IMAGEM:\s*([^\]]+)\]/g;
  const matchImagem = regexImagem.exec(resposta);

  if (matchImagem) {
    const descricaoImagem = matchImagem[1];
    try {
      imagemGerada = await gerarImagemEducativa(descricaoImagem, idioma, aulaAtual);
      respostaProcessada = resposta.replace(matchImagem[0],
        `\nüñºÔ∏è **Imagem gerada!** Observe a imagem que acabei de criar para voc√™.\n\nüìù **Sua tarefa:** Descreva o que voc√™ v√™ na imagem usando o vocabul√°rio que acabamos de aprender!`
      );
    } catch (error) {
      console.error('Erro ao gerar imagem:', error);
      respostaProcessada = resposta.replace(matchImagem[0],
        'üñºÔ∏è Desculpe, n√£o foi poss√≠vel gerar a imagem no momento. Vamos continuar com a aula!'
      );
    }
  }

  // Processa comando de solicita√ß√£o de √°udio
  const regexAudio = /\[SOLICITAR_AUDIO:\s*([^\]]+)\]/g;
  const matchAudio = regexAudio.exec(resposta);

  if (matchAudio) {
    audioSolicitado = matchAudio[1];
    respostaProcessada = resposta.replace(matchAudio[0],
      `\nüé§ **Exerc√≠cio de Pron√∫ncia!**\n\nüì¢ Grave um √°udio pronunciando: "${matchAudio[1]}"\n\nüí° **Dica:** Fale claramente e com calma. Vou analisar sua pron√∫ncia e te dar feedback!`
    );
  }

  return {
    resposta: respostaProcessada,
    imagemGerada,
    audioSolicitado
  };
}

async function gerarImagemEducativa(descricao, idioma, aulaAtual) {
  try {
    const promptImagem = `Educational illustration for ${idioma} language learning. Topic: ${aulaAtual.topico}.
    Create a realistic, modern, and visually appealing image showing: ${descricao}.
    Style: professional, mature, suitable for adults and teenagers, with a sober and elegant look.
    No text in the image, focus on visual elements that help language comprehension.`;

    const response = await openai.images.generate({
      model: "dall-e-3",
      prompt: promptImagem,
      n: 1,
      size: "1024x1024",
      quality: "standard",
      style: "vivid"
    });

    return {
      url: response.data[0].url,
      descricao: descricao,
      topico: aulaAtual.topico
    };
  } catch (error) {
    console.error('Erro ao gerar imagem educativa:', error);
    throw error;
  }
}

export async function analisarAudioPronuncia(audioBuffer, textoEsperado, idioma) {
  try {
    // Converte √°udio para texto usando Whisper
    const transcricao = await openai.audio.transcriptions.create({
      file: audioBuffer,
      model: "whisper-1",
      language: obterCodigoIdioma(idioma),
      response_format: "text"
    });

    // Analisa a pron√∫ncia comparando com o texto esperado
    const analise = await analisarPronunciaComIA(transcricao, textoEsperado, idioma);

    return {
      transcricao: transcricao,
      textoEsperado: textoEsperado,
      analise: analise,
      pontuacao: calcularPontuacaoPronuncia(transcricao, textoEsperado)
    };
  } catch (error) {
    console.error('Erro ao analisar √°udio:', error);
    throw error;
  }
}

async function analisarPronunciaComIA(transcricao, textoEsperado, idioma) {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        {
          role: 'system',
          content: `Voc√™ √© um especialista em pron√∫ncia de ${idioma}. Analise a pron√∫ncia do aluno comparando o que ele disse com o que deveria ter dito.

          INSTRU√á√ïES:
          - Compare a transcri√ß√£o com o texto esperado
          - Identifique erros de pron√∫ncia espec√≠ficos
          - D√™ feedback construtivo e encorajador
          - Sugira melhorias espec√≠ficas
          - Use emojis para tornar o feedback mais amig√°vel
          - Responda em portugu√™s`
        },
        {
          role: 'user',
          content: `Texto esperado: "${textoEsperado}"
          O que o aluno disse: "${transcricao}"

          Analise a pron√∫ncia e d√™ feedback detalhado.`
        }
      ],
      temperature: 0.7,
      max_tokens: 300
    });

    return completion.choices[0].message.content;
  } catch (error) {
    console.error('Erro ao analisar pron√∫ncia com IA:', error);
    return 'N√£o foi poss√≠vel analisar a pron√∫ncia no momento.';
  }
}

function calcularPontuacaoPronuncia(transcricao, textoEsperado) {
  // Algoritmo simples de similaridade
  const palavrasEsperadas = textoEsperado.toLowerCase().split(' ');
  const palavrasTranscritas = transcricao.toLowerCase().split(' ');

  let acertos = 0;
  const totalPalavras = Math.max(palavrasEsperadas.length, palavrasTranscritas.length);

  for (let i = 0; i < Math.min(palavrasEsperadas.length, palavrasTranscritas.length); i++) {
    if (palavrasEsperadas[i] === palavrasTranscritas[i]) {
      acertos++;
    }
  }

  return Math.round((acertos / totalPalavras) * 100);
}

function obterCodigoIdioma(idioma) {
  const codigos = {
    'Ingl√™s': 'en',
    'Espanhol': 'es',
    'Franc√™s': 'fr',
    'Mandarim': 'zh'
  };
  return codigos[idioma] || 'en';
}

function gerarHistoricoAulas(idioma, aulaAtualId) {
  let historico = "Aulas j√° cobertas:\n";

  for (let i = Math.max(1, aulaAtualId - 3); i < aulaAtualId; i++) {
    const aula = obterAulaPorId(idioma, i);
    if (aula) {
      historico += `- Aula ${aula.id}: ${aula.topico} (${aula.conteudo})\n`;
    }
  }

  return historico;
}

async function extrairEAdicionarVocabulario(resposta, usuarioId, idioma) {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `Extraia as palavras mais importantes desta resposta em ${idioma} e forne√ßa suas tradu√ß√µes em portugu√™s.
                   Formato: palavra1:tradu√ß√£o1|palavra2:tradu√ß√£o2|palavra3:tradu√ß√£o3
                   M√°ximo 5 palavras.`
        },
        {
          role: 'user',
          content: resposta
        }
      ],
      temperature: 0.3,
      max_tokens: 150
    });

    const vocabularioExtraido = completion.choices[0].message.content;
    const pares = vocabularioExtraido.split('|');

    for (const par of pares) {
      const [palavra, traducao] = par.split(':');
      if (palavra && traducao) {
        await adicionarVocabulario(usuarioId, palavra.trim(), traducao.trim(), idioma);
      }
    }
  } catch (error) {
    console.error('Erro ao extrair vocabul√°rio:', error);
  }
}

export async function gerarTraducao(texto, idiomaOrigem) {
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `Traduza o seguinte texto de ${idiomaOrigem} para portugu√™s brasileiro.
                   Forne√ßa apenas a tradu√ß√£o, sem explica√ß√µes adicionais.`
        },
        {
          role: 'user',
          content: texto
        }
      ],
      temperature: 0.3,
      max_tokens: 200
    });

    return completion.choices[0].message.content;
  } catch (error) {
    console.error('Erro ao gerar tradu√ß√£o:', error);
    return 'Tradu√ß√£o n√£o dispon√≠vel no momento.';
  }
}

export async function iniciarRevisaoVocabulario(usuarioId, idioma) {
  const palavras = await buscarPalavrasRevisao(usuarioId, 5);

  if (palavras.length === 0) {
    return {
      tipo: 'sem_revisao',
      mensagem: 'Parab√©ns! Voc√™ n√£o tem palavras para revisar no momento. Continue estudando para adicionar mais vocabul√°rio!'
    };
  }

  return {
    tipo: 'revisao',
    palavras: palavras,
    mensagem: `Vamos revisar ${palavras.length} palavras do seu vocabul√°rio!`
  };
}

export class SessaoAulaGuiada {
  constructor(usuarioId, idioma) {
    this.usuarioId = usuarioId;
    this.idioma = idioma;
    this.questoesRespondidas = 0;
    this.questoesCorretas = 0;
    this.inicioSessao = new Date();
    this.maxQuestoes = 25; // Aumentado para acomodar mais intera√ß√µes
    this.maxTempo = 45; // Aumentado para 45 minutos
    this.etapasCompletadas = [];
    this.imagensGeradas = [];
    this.audiosAnalisados = [];
  }

  incrementarQuestao(correta = false) {
    this.questoesRespondidas++;
    if (correta) this.questoesCorretas++;
  }

  adicionarEtapaCompletada(etapa) {
    if (!this.etapasCompletadas.includes(etapa)) {
      this.etapasCompletadas.push(etapa);
    }
  }

  adicionarImagemGerada(imagem) {
    this.imagensGeradas.push(imagem);
  }

  adicionarAudioAnalisado(analise) {
    this.audiosAnalisados.push(analise);
  }

  verificarLimites() {
    const tempoDecorrido = (new Date() - this.inicioSessao) / (1000 * 60);
    const etapasObrigatorias = ['EXPLICACAO_INICIAL', 'EXERCICIO_MULTIPLA_ESCOLHA', 'FORMACAO_FRASES'];
    const etapasObrigatoriasCompletas = etapasObrigatorias.every(etapa =>
      this.etapasCompletadas.includes(etapa)
    );

    return {
      atingiuLimite: (this.questoesRespondidas >= this.maxQuestoes || tempoDecorrido >= this.maxTempo) && etapasObrigatoriasCompletas,
      questoesRestantes: this.maxQuestoes - this.questoesRespondidas,
      tempoRestante: Math.max(0, this.maxTempo - Math.floor(tempoDecorrido)),
      etapasCompletadas: this.etapasCompletadas.length,
      etapasObrigatoriasCompletas
    };
  }

  async finalizarSessao() {
    const duracaoMinutos = Math.floor((new Date() - this.inicioSessao) / (1000 * 60));
    const pontosBase = this.questoesCorretas * 10;
    const bonusEtapas = this.etapasCompletadas.length * 5;
    const bonusImagens = this.imagensGeradas.length * 10;
    const bonusAudios = this.audiosAnalisados.length * 15;
    const pontosGanhos = pontosBase + bonusEtapas + bonusImagens + bonusAudios;

    await registrarSessaoEstudo(this.usuarioId, 'aula_guiada', {
      duracaoMinutos,
      questoesRespondidas: this.questoesRespondidas,
      questoesCorretas: this.questoesCorretas,
      pontosGanhos
    });

    return {
      questoesRespondidas: this.questoesRespondidas,
      questoesCorretas: this.questoesCorretas,
      duracaoMinutos,
      pontosGanhos,
      aproveitamento: Math.round((this.questoesCorretas / this.questoesRespondidas) * 100),
      etapasCompletadas: this.etapasCompletadas.length,
      imagensGeradas: this.imagensGeradas.length,
      audiosAnalisados: this.audiosAnalisados.length,
      bonusDetalhado: {
        pontosBase,
        bonusEtapas,
        bonusImagens,
        bonusAudios
      }
    };
  }
}
